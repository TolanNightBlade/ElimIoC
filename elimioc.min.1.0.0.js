(function(a){var c=function(f,d,e,g,h){this.key=f;this.constructor=d||null;this.createdByFunc=null;this.deps=e||d.prototype.deps;this.params=g||[];this.settings=h||[];this.isSingleton=false;this.instance=null;this.postConstructor=null;this.tracked=false};c.prototype={asSingleton:function(){this.isSingleton=true;return this},asTracked:function(){this.tracked=true;return this},withInstance:function(d){this.instance=d;return this},withPostConstructor:function(d){if(typeof d!=="function"){throw new Error("postConstructor must be of type function.")}this.postConstructor=d;return this},withParameters:function(d){this.params=d;return this},withSettings:function(d){this.settings=d;return this},createdBy:function(d){this.createdByFunc=d;return this}};var b=function(){this.serviceRegistered=new signals.Signal();this.instanceIdCount=0};b.prototype={descriptions:{},instances:{},serviceAdded:null,registerInstance:function(e,d){var f;if(this.hasService(e)){throw new Error("A service with the key "+e+" has already been registered.")}f=new c(e,null,null);f.isSingleton=true;f.instance=d;this.descriptions[e]=f;return f},register:function(f,d,e,g,i){var h;if(this.hasService(f)){throw new Error("A service with the key "+f+" has already been registered.")}h=new c(f,d,e,g,i);this.descriptions[f]=h;this.serviceRegistered.dispatch(h);return h},resolve:function(g){var e=this.descriptions[g],f=e.instance,d=e.constructor.prototype.deps||[];if(!e){throw new Error("IoC Key "+g+" was not found.")}if(e.isSingleton&&f!==null){console.log("Singleton exists");return e.instance}console.log("create:service",e);if(typeof e.createdByFunc==="function"){f=e.createdByFunc.call(e.createdByFunc,[e,this])}else{f=this.createEmptyWithProtoType(e.constructor);e.constructor.apply(f,this.createConstructorItems(d).concat(e.params))}if(typeof e.postConstructor==="function"){e.postConstructor(f,e)}this.applyParams(f,e.settings);if(e.isSingleton){e.instance=f}else{if(e.tracked){this.instanceIdCount++;f.IocTrackingKey="key-"+this.instanceIdCount;this.instances[f.IocTrackingKey]={type:e.key,instance:f}}}return f},applyParams:function(e,g){var d=0,h=(g?g.length:0),f;if(g){for(d;d<h;d=(d+1)){f=g[d];if(typeof e[f.name]==="function"){e[f.name].call(e,f.value)}else{e[f.name]=f.value}}}return e},createEmptyWithProtoType:function(e){var f=function(){};f.prototype=e.prototype;return new f()},createConstructorItems:function(e){var f=0,h=e.length,g,d=[];for(f;f<h;f=(f+1)){g=this.descriptions[e[f]];if(!g){throw new Error("Unknown service "+e[f])}console.log(e[f],g);d.push(this.resolve(e[f]))}return d},release:function(d){delete this.instances[d.IocTrackingKey]},hasService:function(d){return this.descriptions.hasOwnProperty(d)},serviceCount:function(){var d=0,e;for(e in this.descriptions){if(this.descriptions.hasOwnProperty(e)){d++}}return d},singletonCount:function(){var d=0,e;for(e in this.descriptions){if(this.descriptions.hasOwnProperty(e)){if(this.descriptions[e].isSingleton){d++}}}return d}};a.ioc=b;a.container=new b()})(this);
