(function(c){function f(h,g){return"[object "+g+"]"===Object.prototype.toString.call(h)}function a(k){var g={},h=0,j=k.length;for(h;h<j;h=(h+1)){g[k[h].name]=k[h].value}return g}function b(g,h){var j,l,k;if(!g){return null}if(f(g,"Array")){g=a(g)}if(h){j=0;l=h.length;for(j;j<l;j=(j+1)){g[h[j].name]=h[j].value}}return g}var e=function(i,g,h,j,k){this.key=i;this.constructor=g||null;this.createdByFunc=null;this.deps={};this.combineDeps(g.prototype.deps);this.params=j||[];this.settings=k||[];this.isSingleton=false;this.instance=null;this.postConstructor=null;this.tracked=false;this.dontCreate=false;this.combineDeps(h)};e.prototype={combineDeps:function(h){var j=0,k,g;if(!h){return}k=h.length;for(j;j<k;j=(j+1)){if(typeof h[j]==="string"){g={name:h[j],value:h[j]}}else{g=h[j]}this.deps[g.name]=g.value}},asSingleton:function(g){this.isSingleton=true;if(g){this.withInstance(g)}return this},asTracked:function(){this.tracked=true;return this},withInstance:function(g){this.dontCreate=true;this.instance=g;return this},withDependencies:function(g){this.combineDeps(g);return this},withPostConstructor:function(g){if(typeof g!=="function"){throw new Error("postConstructor must be of type function.")}this.postConstructor=g;return this},withParameters:function(g){this.params=g||[];return this},withSettings:function(g){this.settings=g||[];return this},createdBy:function(g){this.createdByFunc=g;return this}};var d=function(){this.serviceRegistered=new signals.Signal();this.instanceIdCount=0};d.prototype={descriptions:{},instances:{},serviceAdded:null,registerInstance:function(h,g){var i=this.register(h).withInstance(g);return i},register:function(j,h,i,k,m){var l,g=j+"@";if(h){if(typeof h.name==="function"){g+=h.name()}else{g+=h.name}}if(this.hasService(g)){throw new Error("A service with the key "+g+" has already been registered.")}l=new e(g,h,i,k,m);this.descriptions[g]=l;this.serviceRegistered.dispatch(l);return l},remove:function(i,h){var g=i+"@";if(h){if(typeof h.name==="function"){g+=h.name()}else{g+=h.name}}this.descriptions[g]=null;delete this.descriptions[g]},findService:function(i){var h=this.descriptions[i],g,j;if(h){return h}g=i.substring(0,i.indexOf("@")+1);for(j in this.descriptions){if(j.indexOf(g)===0){return this.descriptions[j]}}},constructorName:function(g){if(typeof g==="string"){return g}if(g){if(typeof g.name==="function"){return g.name()}else{return g.name}}},resolve:function(h,k,i,j){var g=h+"@"+(k?this.constructorName(k):h);return this._resolve(g,i,j)},resolveWithSettings:function(g,h){return this.resolve(g,null,h,false)},_resolve:function(j,k,l){var h=this.findService(j),i=h.instance,g=h.deps;if(!h){throw new Error("IoC Key "+j+" was not found.")}if(h.dontCreate||(h.isSingleton&&i!==null)){return h.instance}if(typeof h.createdByFunc==="function"){i=h.createdByFunc.call(h.createdByFunc,[h,this])}else{i=this.createEmptyWithProtoType(h.constructor);h.constructor.apply(i,this.createConstructorItems(g).concat(h.params))}if(typeof h.postConstructor==="function"){h.postConstructor(i,h)}this.applyParams(i,b(h.settings,k));if(h.isSingleton){h.instance=i}else{if(h.tracked){this.instanceIdCount++;i.IocTrackingKey="key-"+this.instanceIdCount;this.instances[i.IocTrackingKey]={type:h.key,instance:i}}}return i},applyParams:function(g,h){var i;if(h){for(i in h){if(h.hasOwnProperty(i)){if(typeof g[i]==="function"){g[i].call(g,h[i])}else{g[i]=h[i]}}}}return g},createEmptyWithProtoType:function(g){var h=function(){};h.prototype=g.prototype;return new h()},createConstructorItems:function(h){var j,g=[],i;for(j in h){if(h.hasOwnProperty(j)){g.push(this._resolve(j+"@"+h[j],null,true))}}return g},release:function(g){delete this.instances[g.IocTrackingKey]},hasService:function(g){return this.descriptions.hasOwnProperty(g)},serviceCount:function(){var g=0,h;for(h in this.descriptions){if(this.descriptions.hasOwnProperty(h)){g++}}return g},singletonCount:function(){var g=0,h;for(h in this.descriptions){if(this.descriptions.hasOwnProperty(h)){if(this.descriptions[h].isSingleton){g++}}}return g}};c.ioc=d;c.container=new d()})(this);
