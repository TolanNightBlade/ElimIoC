(function(c,g){function f(i,h){return"[object "+h+"]"===Object.prototype.toString.call(i)}function a(l){var h={},j=0,k=l.length;for(j;j<k;j=(j+1)){h[l[j].name]=l[j].value}return h}function b(h,j){var k,m,l;if(!h){return null}if(f(h,"Array")){h=a(h)}if(j){k=0;m=j.length;for(k;k<m;k=(k+1)){h[j[k].name]=j[k].value}}return h}var e=function(k,j,h,i,l,m){this.name=k;this.key=j;this.constructor=h||null;this.createdByFunc=null;this.deps={};this.params=l||[];this.settings=m||[];this.isSingleton=false;this.instance=null;this.postConstructor=null;this.tracked=false;this.dontCreate=false;if(h){this.combineDeps(h.prototype.deps)}if(i){this.combineDeps(i)}};e.prototype={combineDeps:function(j){var k=0,l,h;if(!j){return}l=j.length;for(k;k<l;k=(k+1)){if(typeof j[k]==="string"){h={name:j[k],value:j[k]}}else{h=j[k]}this.deps[h.name]=h.value}},asSingleton:function(h){this.isSingleton=true;if(h){this.withInstance(h)}return this},asTracked:function(){this.tracked=true;return this},withInstance:function(h){this.dontCreate=true;this.instance=h;return this},withDependencies:function(h){this.combineDeps(h);return this},withPostConstructor:function(h){if(typeof h!=="function"){throw new Error("postConstructor must be of type function.")}this.postConstructor=h;return this},withParameters:function(h){this.params=h||[];return this},withSettings:function(h){this.settings=h||[];return this},createdBy:function(h){this.createdByFunc=h;return this}};var d=function(){this.serviceRegistered=new g.Signal();this.instanceIdCount=0};d.prototype={descriptions:{},names:{},instances:{},serviceAdded:null,registerInstance:function(i,h){var j=this.register(i).withInstance(h);return j},register:function(l,i,k,m,o){var n,h=l+"@",j=this.constructorName(i);h+=j;if(this.hasService(h)){throw new Error("A service with the key "+h+" has already been registered.")}n=new e(l,h,i,k,m,o);this.descriptions[h]=n;if(!this.names.hasOwnProperty(l)){this.names[l]={}}this.names[l][j]=j;this.serviceRegistered.dispatch(n);return n},registerSingleton:function(j,h,i,k,l){return this.register(j,h,i,k,l).asSingleton()},remove:function(j,i){var h=j+"@";if(i){if(typeof i.name==="function"){h+=i.name()}else{h+=i.name}}this.descriptions[h]=null;delete this.descriptions[h]},findService:function(j){var i=this.descriptions[j],h=j,k,l;if(i){return i}l=j.indexOf("@");if(l>-1){h=j.substring(0,j.indexOf("@")+1)}for(k in this.descriptions){if(this.descriptions.hasOwnProperty(k)&&k.indexOf(h)===0){return this.descriptions[k]}}return null},constructorName:function(h){if(typeof h==="string"){return h}if(h){if(typeof h.name==="function"){return h.name()}else{return h.name}}},resolve:function(i,l,j,k){var h=i+"@"+(l?this.constructorName(l):i);return this._resolve(h,j,k)},resolveWithSettings:function(h,i){return this.resolve(h,null,i,false)},_resolve:function(k,l,m){var i=this.findService(k),j=i.instance,h=i.deps;if(!i){throw new Error("IoC Key "+k+" was not found.")}if(i.dontCreate||(i.isSingleton&&j!==null)){return i.instance}if(typeof i.createdByFunc==="function"){j=i.createdByFunc.call(i.createdByFunc,[i,this])}else{j=this.createEmptyWithProtoType(i.constructor);i.constructor.apply(j,this.createConstructorItems(h).concat(i.params))}if(typeof i.postConstructor==="function"){i.postConstructor(j,i)}this.applyParams(j,b(i.settings,l));if(i.isSingleton){i.instance=j}else{if(i.tracked){this.instanceIdCount++;j.IocTrackingKey="key-"+this.instanceIdCount;this.instances[j.IocTrackingKey]={type:i.key,instance:j}}}return j},applyParams:function(h,i){var j;if(i){for(j in i){if(i.hasOwnProperty(j)){if(typeof h[j]==="function"){h[j].call(h,i[j])}else{h[j]=i[j]}}}}return h},createEmptyWithProtoType:function(h){var i=function(){};i.prototype=h.prototype;return new i()},createConstructorItems:function(i){var k,h=[],j;for(k in i){if(i.hasOwnProperty(k)){h.push(this._resolve(k+"@"+i[k],null,true))}}return h},release:function(h){delete this.instances[h.IocTrackingKey]},hasService:function(h){return this.descriptions.hasOwnProperty(h)},serviceCount:function(){var h=0,j;for(j in this.descriptions){if(this.descriptions.hasOwnProperty(j)){h++}}return h},singletonCount:function(){var h=0,j;for(j in this.descriptions){if(this.descriptions.hasOwnProperty(j)){if(this.descriptions[j].isSingleton){h++}}}return h}};c.ioc=d;c.container=new d()})(this,this.signals);